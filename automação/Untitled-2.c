/*
 *  PROJETO DA FACULDADE - CIÊNCIA DA COMPUTAÇÃO
 *  PROJETO DE IRRIGAÇÃO AUTOMATIZADA COM ARDUINO
 *  AUTOR:Allan Rodrigues
 *  DATA:15/04/2021
 *  VERSÃO:1.0
 *  AMBIENTE: DESENVOLVIMENTO E HOMOLOGAÇÃO
 *  DATA DEPLOY: A COMBINAR
*/

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inclui as Bibliotecas do Display TFT, do Sensor DHT22, do RTC e do Timer
#include <Adafruit_GFX.h>    
#include <Adafruit_TFTLCD.h> 
#include "DHT.h"
#include <DS3231.h>
#include <Timer.h>    
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Definição de Sinônimos para as Cores de 8-bits
#define BLACK           0x0000
#define BLUE            0x001F
#define RED             0xF800
#define GREEN           0x07E0
#define CYAN            0x07FF
#define MAGENTA         0xF81F
#define YELLOW          0xFFE0
#define WHITE           0xFFFF
 
//Define os Pinos do LCD TFT (CS, CD, WR, RD, RESET)
Adafruit_TFTLCD tft(A3, A2, A1, A0, A4);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define sinônimos para os Leds
#define Led_01 39
#define Led_02 41
#define Led_03 43
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define sinônimos dos pinos para os Relés
#define Rele_01 42
#define Rele_02 44
#define Rele_03 46
#define Rele_04 48
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Definição de Sinônimo para o Pino Analógico do Sensor de Humidade do Solo
#define Pino_Anl_SHMDS A8
#define Pino_Dig_SHMDS 25
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Definição do modelo do sensor e do pino digital usado para o Sensor de Humidade e Temperatura do Ar
#define PINODHT 35         // O pino digital que conecta o sensor ao arduino
#define TIPODHT DHT22     // Modelo do Sensor: DHT22  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define Sinônimo para o Pino Digital de PWM usado para o Sensor de Vazão
#define Pino_PWM_Vazao 18
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Variáveis de Tempo para o Programa
const unsigned long Temp_1 = 1000;                             //Um Segundo
const unsigned long Temp_2 = 8000;
unsigned long Temp_3 = 0;
int long Temp_Corrido;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define as variáveis utilizadas para o RTC 
//Dia da Semana Em String
int Dia_Str;
//Dia/Mês/Ano
int DMA;
//Tempo ou Horas
unsigned long Tempo;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define as variáveis usadas para o Sensor de Chuva
int Pino_Dig_Chuva = 30;                    //Pino ligado ao D0 do sensor
int Pino_Anl_Chuva = A9;                   //Pino ligado ao A0 do sensor
int Leit_Dig_Chuva = 0;                   //Armazena o valor lido do pino digital
int Leit_Anl_Chuva = 0;                  //Armazena o valor lido do pino analogico
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Definição das variáveis usadas para o Sensor de Vazão
float Vazao;                 //Variável para armazenar o valor em L/min
float Media_Min = 0;        //Variável para obter a média a cada 1 minuto
float Preco_Atual;         //Variável para cálculo do preço aproximado
float Preco_Acum;         //Variável para somar o preço total
int Cont_Pulso;          //Variável para a contagem da quantidade de pulsos
int Cont = 0;           //Variável para contagem e incremento
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define duas variáveis para armazenar a Leitura do Pino Analógico e Digital do Sensor de Humidade do Solo Respectivamente
int Leit_Anl_SHMDS;
int Leit_Dig_SHMDS;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define duas variáveis do tipo real H (Humidade) e T (Temperatura) para armazenar as leituras do Sensor DHT22 
float H, T = 0; 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inicializa a função Timer com uma variável T
  Timer t;  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta as configurações(Pino,Tipo) do Sensor DHT22
  DHT dht(PINODHT, TIPODHT);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inicia o RTC DS3231 com a interface de Hardware Setando os pinos usados
  DS3231  rtc(SDA, SCL);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void setup() {

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta o modo do pino 18 como entrada PWM (Usada para leitura da quantidade de pulsos do sensor de Vazão)
  pinMode(Pino_PWM_Vazao, INPUT);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta o modo dos pinos dos Leds como saída
  pinMode(Led_01, OUTPUT);
  pinMode(Led_02, OUTPUT);
  pinMode(Led_03, OUTPUT);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta o modo dos pinos dos Relés como saída
  pinMode(Rele_01, OUTPUT);
  pinMode(Rele_02, OUTPUT);
  pinMode(Rele_03, OUTPUT);
  pinMode(Rele_04, OUTPUT);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta os LEDs para nível lógico BAIXO = 0 e os Reles para Nível lógico ALTO = 1 (Reles tem a lógica invetida)
  digitalWrite(Led_01, LOW);
  digitalWrite(Led_02, LOW);
  digitalWrite(Led_03, LOW);
  digitalWrite(Rele_01, HIGH);
  digitalWrite(Rele_02, HIGH);
  digitalWrite(Rele_03, HIGH);
  digitalWrite(Rele_04, HIGH);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta as configurações referentes ao pino 18 para trabalhar com a interrupção por borda de Subida do pulso
  attachInterrupt(digitalPinToInterrupt(Pino_PWM_Vazao), Inc_Pulso, RISING); 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inicializa o RTC com a interface de Software
  rtc.begin();
//As linhas comentadas abaixo devem ser acionadas uma única vez para setar a data do RTC
  /*
  rtc.setDOW(SUNDAY);           // Set Day-of-Week to SUNDAY
  rtc.setTime(13, 10, 0);      // Set the time to 12:00:00 (24hr format)
  rtc.setDate(18, 9, 2016);   // Set the date to January 1st, 2014
  */
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inicializa o Sensor de Temperatura e Umidade do Ar DHT22
  dht.begin();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Inicializa o Display
  tft.begin(0x9341);
  tft.setRotation(2);
  tft.fillScreen(BLACK);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

void loop() {
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////  
//Chama as funções para execução e exibição no Display
  Leitura_Sensores();
  Acionamentos();
  Falhas();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Temp_Corrido = millis();

  if (Temp_Corrido - Temp_3 > Temp_2)
  {
    Temp_3 = Temp_Corrido;
    Atualizar_Display();
  }  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Sistema_Ativo();
}

void Sistema_Ativo(){
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//LED INDICATIVO PARA O SISTEMA DE IRRIGAÇÃO
  while(Leit_Dig_SHMDS && Leit_Dig_Chuva && PINODHT != 0 && 1)
  {
    digitalWrite(Led_03, HIGH);
//  Pisca_Led_3();
//  t.update();
    break;   
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

void Leitura_Sensores(){

//LEITURA SENSOR DE HUMIDADE E TEMPERATURA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Atribui as leituras de Humidade e Temperatura as respectivas variáveis H e T
  H = dht.readHumidity();
  T = dht.readTemperature();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//LEITURA SENSOR DE CHUVA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Le e armazena o valor do pino digital(30) usado para o Sensor de Chuva
  Leit_Dig_Chuva = digitalRead(Pino_Dig_Chuva);
//Le e armazena o valor do pino analogico(A7) usado para o Sensor de Chuva
  Leit_Anl_Chuva = analogRead(Pino_Anl_Chuva);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//LEITURA SENSOR DE HUMIDADE DO SOLO
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Lê os valores dos pinos analógico(A8) e digital(25) e armazena em suas respectivas variáveis
  Leit_Anl_SHMDS = analogRead(Pino_Anl_SHMDS);
  Leit_Dig_SHMDS = digitalRead(Pino_Dig_SHMDS);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//LEITURA SENSOR DE VAZÃO
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Cont_Pulso = 0;                                        //Zera a variável para contar os giros por segundos
  sei();                                                //Habilita interrupção
  delay (1000);                                        //Aguarda 1 segundo
  cli();                                              //Desabilita interrupção
  
  Vazao = Cont_Pulso / 7.5;                          //Converte para L/min
  Media_Min = Media_Min + Vazao;                    //Soma a vazão para o cálculo da média
  Cont++;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
delay(2000);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Inc_Pulso()
{ 
  Cont_Pulso++;        //Incrementa a variável de contagem dos pulsos
} 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Atualizar_Display(){
  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Imprime as leituras do Sensor de Humidade e Temperatura DHT22 no Display
  tft.fillScreen(BLACK);
  tft.setTextSize(3);
  tft.setTextColor(YELLOW);
  tft.setCursor(0, 5);
  tft.print("IRRIGADOR");
  tft.setTextColor(WHITE);
  tft.setCursor(0, 35);
  tft.print("Hum:");
  tft.print(H);
  tft.print("%");
  tft.setTextColor(WHITE);
  tft.setCursor(0, 65);
  tft.print("Temp:");
  tft.print(T);
  tft.print("C");  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Realiza a comparação se esta Chovendo ou Não e imprime no Display
  if (Leit_Dig_Chuva == 1)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 95);
    tft.print("Chuva:");
    tft.print("Nao");
  }
  else
  {
    tft.setTextSize(3);
    tft.setCursor(0, 95);
    tft.print("Chuva:");
    tft.print("Sim");
  }
 
//Imprime no Display o nivel de Intensidade da Chuva
  if (Leit_Anl_Chuva > 767.25 && Leit_Anl_Chuva < 1023)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 125);
    tft.print("Intens:");
    tft.print("N/A");
  }
  else if (Leit_Anl_Chuva > 511.5 && Leit_Anl_Chuva < 767.25)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 125);
    tft.print("Intens:");
    tft.print("Fraca");
  }
  else if (Leit_Anl_Chuva > 255.75 && Leit_Anl_Chuva < 511.5)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 125);
    tft.print("Intens:");
    tft.print("Media");
  }
  else if (Leit_Anl_Chuva < 255.75)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 125);
    tft.print("Intens:");
    tft.print("Forte");
  }    
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Imprime no Display se existe Umidade no Solo ou Não

  if(Leit_Anl_SHMDS > 255.75 && Leit_Anl_SHMDS < 511.5)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 155);
    tft.print("Solo:");
    tft.print("Umido");
  }
  else
  {
    tft.setTextSize(3);
    tft.setCursor(0, 155);
    tft.print("Solo:");
    tft.print("Seco");
  }

//Imprime no Display o Nível de Humidade do Solo
  if (Leit_Anl_SHMDS > 0 && Leit_Anl_SHMDS < 255.75)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 185);
    tft.print("Nivel:N/A");
  }
 
  if (Leit_Anl_SHMDS > 255.75 && Leit_Anl_SHMDS < 511.5)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 185);
    tft.print("Nivel:Umido");
  }

  if (Leit_Anl_SHMDS > 511.5 && Leit_Anl_SHMDS < 767.25)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 185);
    tft.print("Nivel:Moder.");
  }

  if (Leit_Anl_SHMDS > 767.25 && Leit_Anl_SHMDS < 1023)
  {
    tft.setTextSize(3);
    tft.setCursor(0, 185);
    tft.print("Nivel:Seco");
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Realização de alguns cáculos e comparações para o sensor de vazão
  tft.setTextSize(3);
  tft.setCursor(0, 215);
  tft.print("Vaz:");
  tft.print(Vazao);                                     //Imprime na serial o valor da vazão
  tft.print("L/min");                                  //Imprime L/min
  tft.setCursor(0, 245);
  tft.print("Preco:R$");                             //Imprime a String Preco por min = R$ 
  tft.print(Preco_Atual);                           //Imprime o valor da variável Preço

  
  if(Cont == 60)
  {
    Media_Min = Media_Min / 60;                                           //Tira a media dividindo por 60
    Preco_Atual = Media_Min / 16.6667 * 0.2530;                          //Realiza o Cálculo Aproximado do Preço
    Preco_Acum = Preco_Atual + Preco_Atual;                             //Soma os preços por minuto e armazena em uma variável total
  }

   Media_Min = 0;                                                     //Zera a variável Media para uma nova contagem
   Cont = 0;                                                         //Zera a variável Cont para uma nova contagem
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

void Acionamentos(){

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Acionamento da Válvula solenoide para passagem da Água e do LED para exemplificação 
  if(Leit_Anl_SHMDS > 255.75 && Leit_Anl_SHMDS < 511.5)
  {
    digitalWrite(Rele_01,HIGH);
    digitalWrite(Led_02,LOW);
  }
  else
  {
    digitalWrite(Rele_01,LOW);
    digitalWrite(Led_02,HIGH);
    Pisca_Led_2();
    t.update();
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

//Led Verde
void Pisca_Led_3(){
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta as configurações de tempo para cionamento do LED
  int T3 = t.oscillate(Led_03, Temp_1, LOW);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

//Led Branco
void Pisca_Led_2(){
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta as configurações de tempo para cionamento do LED
  int T2 = t.oscillate(Led_02, Temp_1, LOW);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

//Led Amarelo
void Pisca_Led_1(){
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Seta as configurações de tempo para cionamento do LED
  int T1 = t.oscillate(Led_01, Temp_1, LOW);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}

void Falhas(){

//FALHA PARA O SENSOR DE HUMIDADE E TEMPERATURA DHT22
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Verifica se ocorreu alguma falha na leitura e imprime no LCD "Falha Sensor DHT22"
  if (isnan(H) || isnan(T)) {
//    tft.setTextSize(3);
//    tft.setCursor(0, 35);
//    tft.print("Falha Sensor DHT22");
//Dentro da Rotina de FALHAS para cada falha a função ira acionar o Led para indicar que existe algo de errado
    digitalWrite(Led_01,HIGH);
    Pisca_Led_1();
    t.update();
    delay(500);
    return;
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//FALHA PARA O SENSOR DE CHUVA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Verifica se ocorreu alguma falha na leitura e imprime no LCD "Falha Sensor de Chuva"
  if (isnan(Leit_Dig_Chuva)) {
//    tft.setTextSize(3);
//    tft.setCursor(0, 95);
//    tft.print("Falha Sensor Chuva");
//Dentro da Rotina de FALHAS para cada falha a função ira acionar o Led para indicar que existe algo de errado
    digitalWrite(Led_01,HIGH);
    Pisca_Led_1();
    t.update();
    delay(500);
    return;
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//FALHA PARA O SENSOR DE HUMIDADE DO SOLO
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Verifica se ocorreu alguma falha na leitura e imprime no LCD "Falha Sensor de Solo"
  if (isnan(Leit_Dig_SHMDS)) {
//    tft.setTextSize(3);
//    tft.setCursor(0, 155);
//    tft.print("Falha Sensor Solo");
//Dentro da Rotina de FALHAS para cada falha a função ira acionar o Led para indicar que existe algo de errado
    digitalWrite(Led_01,HIGH);
    Pisca_Led_1();
    t.update();
    delay(500);
    return;
  }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//FALHA PARA O SENSOR DE VAZÃO
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Verifica se ocorreu alguma falha na leitura e imprime no LCD "Falha Sensor de Vazão"
  if (isnan(Pino_PWM_Vazao)) {
//    tft.setTextSize(3);
//    tft.setCursor(0, 215);
//    tft.print("Falha Sensor Vazao");
//Dentro da Rotina de FALHAS para cada falha a função ira acionar o Led para indicar que existe algo de errado
    digitalWrite(Led_01,HIGH);
    Pisca_Led_1();
    t.update();
    delay(500);
    return;
  }
}

void RTC_Clock(){
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Define as configurações para o RTC 
//Dia da Semana Em String
  Dia_Str = rtc.getDOWStr();
//Dia/Mês/Ano
  DMA = rtc.getDateStr();
//Tempo ou Horas
  Tempo = rtc.getTimeStr();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
